.PHONY: help build install clean test hooks daemon-start daemon-stop daemon-status uninstall configure

# Variables
BINARY_NAME=apilo
VERSION=2.0.0
BUILD_DIR=bin
INSTALL_PATH=$(HOME)/go/bin
CLAUDE_HOOKS_DIR=$(HOME)/.claude/hooks
CLAUDE_TOOLS_DIR=$(HOME)/.claude/tools
CLAUDE_COMMANDS_DIR=$(HOME)/.claude/commands
APILO_CONFIG_DIR=$(HOME)/.apilo
APILO_LOGS_DIR=$(HOME)/.apilo/logs

# Get build information
BUILD_TIME=$(shell date -u '+%Y-%m-%d %H:%M:%S UTC')
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
SOURCE_DIR=$(shell pwd)

# Build flags
LDFLAGS=-ldflags="-w -s \
	-X 'apilo/internal/build.Version=$(VERSION)' \
	-X 'apilo/internal/build.BuildTime=$(BUILD_TIME)' \
	-X 'apilo/internal/build.Commit=$(GIT_COMMIT)' \
	-X 'apilo/internal/build.SourceDir=$(SOURCE_DIR)'"

help: ## Show this help message
	@echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
	@echo 'â•‘                    Apilo Makefile Help                            â•‘'
	@echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
	@echo ''
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ''
	@echo 'Quick Start:'
	@echo '  make install         # Build and install apilo globally'
	@echo '  make configure       # Setup Claude Code integration'
	@echo '  make daemon-start    # Start the daemon'
	@echo ''

build: ## Build apilo binary
	@echo "ðŸ”¨ Building $(BINARY_NAME)..."
	@mkdir -p $(BUILD_DIR)
	@go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) .
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

install: build ## Build and install apilo globally
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                  Installing Apilo CLI                             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ðŸ“¦ Installing $(BINARY_NAME) to $(INSTALL_PATH)..."
	@go install $(LDFLAGS)
	@echo "âœ… Installation complete!"
	@echo ""
	@echo "ðŸ“‹ Installed:"
	@echo "   â€¢ Binary: $(INSTALL_PATH)/$(BINARY_NAME)"
	@echo ""
	@echo "ðŸŽ¯ Next steps:"
	@echo "   1. make configure    # Setup Claude Code integration"
	@echo "   2. make daemon-start # Start background daemon"
	@echo ""
	@echo "ðŸ’¡ Run 'apilo --help' to see available commands"

configure: install ## Install and configure Claude Code integration
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘            Configuring Claude Code Integration                    â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ðŸ”§ Setting up directories..."
	@mkdir -p $(CLAUDE_HOOKS_DIR)
	@mkdir -p $(CLAUDE_TOOLS_DIR)
	@mkdir -p $(CLAUDE_COMMANDS_DIR)
	@mkdir -p $(APILO_CONFIG_DIR)
	@mkdir -p $(APILO_LOGS_DIR)
	@echo "âœ… Directories created"
	@echo ""
	@echo "ðŸª Installing Claude Code integration..."
	@$(INSTALL_PATH)/$(BINARY_NAME) claude install
	@echo ""
	@echo "âœ… Configuration complete!"
	@echo ""
	@echo "ðŸ“Š Installed components:"
	@echo "   â€¢ Hook:    $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh"
	@echo "   â€¢ Tool:    $(CLAUDE_TOOLS_DIR)/apilo.json"
	@echo "   â€¢ Command: $(CLAUDE_COMMANDS_DIR)/apilo"
	@echo "   â€¢ Config:  $(APILO_CONFIG_DIR)/"
	@echo ""
	@echo "ðŸš€ Start daemon: make daemon-start"

hooks: ## Install only Claude Code hooks (lightweight)
	@echo "ðŸª Installing Claude Code hooks..."
	@mkdir -p $(CLAUDE_HOOKS_DIR)
	@cp hooks/apilo-optimizer.sh $(CLAUDE_HOOKS_DIR)/
	@chmod +x $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh
	@echo "âœ… Hook installed: $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh"
	@echo ""
	@echo "ðŸ“ Hook enables automatic API optimization"
	@echo "ðŸš€ Start daemon: make daemon-start"

daemon-start: ## Start the apilo daemon
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                  Starting Apilo Daemon                            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon start
	@echo ""
	@echo "âœ… Daemon started!"
	@echo ""
	@echo "ðŸ“Š Monitor: make daemon-status"
	@echo "ðŸ“‹ Logs:    make daemon-logs"

daemon-stop: ## Stop the apilo daemon
	@echo "ðŸ›‘ Stopping apilo daemon..."
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon stop

daemon-restart: ## Restart the apilo daemon
	@echo "ðŸ”„ Restarting apilo daemon..."
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon restart

daemon-status: ## Check daemon status
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon status

daemon-logs: ## View daemon logs
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon logs

test: ## Run tests
	@echo "ðŸ§ª Running tests..."
	@go test -v ./... 2>&1 | grep -v "no test files" || true
	@echo "âœ… Tests complete"

test-coverage: ## Run tests with coverage
	@echo "ðŸ§ª Running tests with coverage..."
	@go test -v -cover -coverprofile=coverage.out ./... 2>&1 | grep -v "no test files" || true
	@go tool cover -html=coverage.out -o coverage.html 2>/dev/null || true
	@echo "âœ… Coverage report: coverage.html"

test-daemon: build ## Test daemon functionality locally
	@echo "ðŸ§ª Testing daemon commands..."
	@echo ""
	@echo "1. Testing daemon --help..."
	@./$(BUILD_DIR)/$(BINARY_NAME) daemon --help | head -15
	@echo ""
	@echo "2. Testing daemon status..."
	@./$(BUILD_DIR)/$(BINARY_NAME) daemon status || echo "âœ“ Daemon not running (expected)"
	@echo ""
	@echo "âœ… Daemon commands functional"

clean: ## Clean build artifacts
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@rm -f coverage.out coverage.html
	@echo "âœ… Clean complete"

clean-all: clean ## Clean all artifacts including daemon data
	@echo "ðŸ§¹ Cleaning all daemon artifacts..."
	@rm -f $(APILO_CONFIG_DIR)/daemon.pid
	@rm -rf $(APILO_LOGS_DIR)/*
	@echo "âœ… All artifacts cleaned"

uninstall: ## Uninstall apilo and remove all components
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                  Uninstalling Apilo                               â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@$(INSTALL_PATH)/$(BINARY_NAME) daemon stop 2>/dev/null || true
	@echo "ðŸ—‘ï¸  Removing components..."
	@rm -f $(INSTALL_PATH)/$(BINARY_NAME)
	@rm -f $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh
	@rm -f $(CLAUDE_TOOLS_DIR)/apilo.json
	@rm -f $(CLAUDE_COMMANDS_DIR)/apilo
	@rm -f $(APILO_CONFIG_DIR)/daemon.pid
	@echo "âœ… Uninstall complete"
	@echo ""
	@echo "ðŸ“ Configuration preserved in: $(APILO_CONFIG_DIR)"
	@echo "   To fully remove: rm -rf $(APILO_CONFIG_DIR)"

fmt: ## Format code
	@echo "ðŸŽ¨ Formatting code..."
	@go fmt ./...
	@echo "âœ… Format complete"

deps: ## Download and tidy dependencies
	@echo "ðŸ“¦ Downloading dependencies..."
	@go mod download
	@go mod tidy
	@echo "âœ… Dependencies updated"

check-install: ## Verify installation
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                  Verifying Installation                          â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ðŸ” Checking binary..."
	@which $(BINARY_NAME) || echo "âŒ Binary not found in PATH"
	@echo ""
	@echo "ðŸ” Checking version..."
	@$(BINARY_NAME) version || echo "âŒ Binary not executable"
	@echo ""
	@echo "ðŸ” Checking hook..."
	@ls -la $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh || echo "âš ï¸  Hook not installed (run: make configure)"
	@echo ""
	@echo "ðŸ” Checking daemon status..."
	@$(BINARY_NAME) daemon status || echo "âš ï¸  Daemon not running (start with: make daemon-start)"
	@echo ""
	@echo "âœ… Verification complete"

all: clean deps build install configure ## Complete setup: clean, deps, build, install, and configure
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘           APILO INSTALLATION COMPLETE                             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "âœ… Binary installed:  $(INSTALL_PATH)/$(BINARY_NAME)"
	@echo "âœ… Hook installed:    $(CLAUDE_HOOKS_DIR)/apilo-optimizer.sh"
	@echo "âœ… Config directory:  $(APILO_CONFIG_DIR)"
	@echo ""
	@echo "ðŸš€ Quick Start Guide:"
	@echo ""
	@echo "   1. Start daemon:"
	@echo "      $$ make daemon-start"
	@echo ""
	@echo "   2. Check status:"
	@echo "      $$ make daemon-status"
	@echo ""
	@echo "   3. Use Claude Code normally - API calls auto-optimized!"
	@echo ""
	@echo "ðŸ“Š Monitoring Commands:"
	@echo "   make daemon-status    # Check daemon health"
	@echo "   make daemon-logs      # View logs"
	@echo "   apilo --help          # See all commands"
	@echo ""
	@echo "ðŸ“š Documentation:"
	@echo "   cat DAEMON.md         # Daemon documentation"
	@echo "   cat HOOK_GUIDE.md     # Hook documentation"
	@echo "   cat INSTALLATION.md   # Installation guide"
	@echo ""

run: build ## Build and run apilo locally
	@echo "ðŸš€ Running apilo..."
	@./$(BUILD_DIR)/$(BINARY_NAME)

version: ## Show version information
	@$(BINARY_NAME) version 2>/dev/null || ./$(BUILD_DIR)/$(BINARY_NAME) version

# Default target
.DEFAULT_GOAL := help
